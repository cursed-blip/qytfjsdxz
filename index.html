<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SkidProt — Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#050615; --bg2:#07102a; --glass: rgba(255,255,255,0.03);
    --muted:#9aa4b2; --accent:#4f46e5; --accent2:#60a5fa;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:
    radial-gradient(circle at 10% 10%, var(--bg2) 0%, var(--bg1) 40%, #000 100%);color:#e6eef8}
  .wrap{min-height:100vh;display:flex;flex-direction:column}
  header{position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;
    padding:14px 20px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    border-bottom:1px solid rgba(255,255,255,0.03);backdrop-filter: blur(8px);z-index:30}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));
    display:flex;align-items:center;justify-content:center;font-weight:800;color:white}
  nav{display:flex;gap:12px;align-items:center}
  nav a{color:var(--muted);text-decoration:none;padding:8px;border-radius:8px}
  .cta{background:linear-gradient(90deg,var(--accent),#2563eb);padding:8px 12px;border-radius:9px;color:white;font-weight:600}
  main{flex:1;padding:28px;display:flex;flex-direction:column;gap:20px;align-items:center}

  .hero{max-width:1100px;width:100%;display:grid;grid-template-columns:1fr 360px;gap:20px;align-items:start}
  .h-title{font-size:34px;margin:0 0 8px;background:linear-gradient(90deg,var(--accent2),#b0c7ff);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:800}
  .h-sub{color:var(--muted);margin:0 0 14px}

  .panel{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:14px;border-radius:12px;backdrop-filter: blur(8px)}
  .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:14px}
  .card{padding:14px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 20px rgba(0,0,0,0.5);transition:transform .18s}
  .card:hover{transform:translateY(-6px)}
  .stat{font-size:22px;font-weight:700;color:#dbeafe}

  .controls{display:flex;flex-direction:column;gap:10px}
  input[type=text],textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#e6eef8}
  button.btn{padding:10px 12px;border-radius:9px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);color:white;cursor:pointer}
  button.primary{background:linear-gradient(90deg,var(--accent),#2563eb);box-shadow:0 12px 30px rgba(79,70,229,0.16)}
  .muted{color:var(--muted);font-size:13px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  footer{padding:10px;text-align:center;color:var(--muted);font-size:13px;border-top:1px solid rgba(255,255,255,0.03)}
  @media (max-width:980px){.hero{grid-template-columns:1fr}.cards{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:640px){.cards{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">SP</div>
      <div><div style="font-weight:700">SkidProt</div><div class="muted" style="font-size:12px">DDoS control panel</div></div>
    </div>
    <nav>
      <a href="/">Home</a>
      <a href="/dashboard">Dashboard</a>
      <a href="/settings">Settings</a>
      <button class="cta" id="modeBtn">Local mode</button>
    </nav>
  </header>

  <main>
    <section class="hero">
      <div>
        <h2 class="h-title">SkidProt — Protection & Controls</h2>
        <p class="h-sub">Lightweight dashboard for blocking IPs, viewing stats, and managing a small protection list. Use remote persistence via Supabase (optional) or localStorage fallback.</p>

        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div class="muted">Status</div><div id="statusLine">OK (local)</div></div>
            <div style="text-align:right"><div class="muted">Backend</div><div id="backendInfo">none</div></div>
          </div>
          <div style="margin-top:10px" class="cards">
            <div class="card"><div class="muted">Active bans</div><div class="stat" id="stat-bans">0</div></div>
            <div class="card"><div class="muted">API Calls (session)</div><div class="stat" id="stat-calls">0</div></div>
            <div class="card"><div class="muted">Blocked (session)</div><div class="stat" id="stat-blocked">0</div></div>
          </div>
        </div>

        <div class="panel" style="margin-top:12px">
          <h3 style="margin:0 0 8px">Quick controls</h3>
          <div class="controls">
            <div style="display:flex;gap:8px">
              <input id="ipInput" type="text" placeholder="IP to block (e.g. 1.2.3.4)" />
              <button class="btn primary" id="btnBlock">Block</button>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="ipUn" type="text" placeholder="IP to unblock" />
              <button class="btn" id="btnUnblock">Unblock</button>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn" id="btnRefresh">Refresh</button>
              <button class="btn" id="btnClearLogs">Clear logs</button>
            </div>
            <div class="muted" style="margin-top:8px">Banlist persists only when remote is enabled (Supabase). Local mode uses localStorage and is ephemeral on the client.</div>
          </div>
        </div>
      </div>

      <aside class="panel">
        <h4 style="margin:0 0 8px">Banlist & Logs</h4>
        <div style="margin-bottom:8px">
          <div class="muted">Banlist</div>
          <div id="banList" style="max-height:160px;overflow:auto;margin-top:8px"></div>
        </div>
        <div style="margin-top:8px">
          <div class="muted">Recent logs</div>
          <div id="logBox" style="max-height:200px;overflow:auto;margin-top:8px;font-size:13px"></div>
        </div>
      </aside>
    </section>

    <section style="width:100%;max-width:1100px">
      <div class="panel">
        <h4 style="margin:0 0 10px">Advanced</h4>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="simulate-req">Simulate Request</button>
          <button class="btn" id="simulate-attack">Simulate Small Attack</button>
          <label style="display:flex;align-items:center;gap:8px;margin-left:12px"><input type="checkbox" id="autorefresh" /> Auto-refresh</label>
        </div>

        <div style="margin-top:12px">
          <div class="muted">Raw API / admin</div>
          <table style="width:100%;margin-top:8px">
            <thead><tr><th>Endpoint</th><th>Action</th></tr></thead>
            <tbody>
              <tr><td>/api/stats</td><td><button class="btn" id="call-stats">GET stats</button></td></tr>
              <tr><td>/api/banlist</td><td><button class="btn" id="call-banlist">GET banlist</button></td></tr>
              <tr><td>/api/block</td><td><button class="btn" id="call-block">POST block 1.2.3.4</button></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <footer>© 2025 SkidProt — demo</footer>
</div>

<script>
/* FRONTEND logic: interacts with /api/* endpoints (serverless).
   If serverless not present, falls back to localStorage and client only. */

const el = id => document.getElementById(id);
let calls = 0, blocked = 0;

const apiAvailable = async () => {
  try {
    const r = await fetch('/api/status');
    return r.ok;
  } catch (e) { return false; }
};

async function refreshStatus() {
  const server = await apiAvailable();
  if (server) {
    el('modeBtn').textContent = 'Remote mode';
    el('backendInfo').textContent = 'api (serverless)';
    try {
      const s = await (await fetch('/api/stats')).json();
      el('stat-bans').textContent = s.banlist.length;
      el('stat-calls').textContent = s.calls ?? calls;
      el('stat-blocked').textContent = s.blocked ?? blocked;
      renderBanlist(s.banlist);
      renderLogs(s.logs || []);
      pushLocalLog('Refreshed from API');
    } catch (e) {
      pushLocalLog('Error fetching /api/stats: '+e.message);
    }
  } else {
    el('modeBtn').textContent = 'Local mode';
    el('backendInfo').textContent = 'none';
    // local fallback
    const saved = localStorage.getItem('skidprot_bans');
    const bans = saved ? JSON.parse(saved) : [];
    el('stat-bans').textContent = bans.length;
    el('stat-calls').textContent = calls;
    el('stat-blocked').textContent = blocked;
    renderBanlist(bans);
    renderLogs(getLocalLogs());
  }
}

function renderBanlist(list) {
  const out = el('banList');
  out.innerHTML = '';
  (list||[]).forEach(ip=>{
    const d = document.createElement('div'); d.style.padding='6px 4px';
    d.textContent = ip;
    out.appendChild(d);
  });
}

function renderLogs(arr) {
  const box = el('logBox'); box.innerHTML='';
  const rows = arr.slice().reverse().slice(0,80);
  rows.forEach(r=>{
    const d = document.createElement('div'); d.style.padding='6px 4px';
    d.textContent = typeof r==='string'? r : (r.t? `${r.t} — ${r.txt}` : JSON.stringify(r));
    box.appendChild(d);
  });
}

function pushLocalLog(txt) {
  const logs = getLocalLogs();
  logs.push({t: new Date().toLocaleString(), txt});
  if (logs.length>300) logs.shift();
  localStorage.setItem('skidprot_logs', JSON.stringify(logs));
  renderLogs(logs);
}
function getLocalLogs(){ return JSON.parse(localStorage.getItem('skidprot_logs')||'[]'); }
function saveLocalBanlist(arr){ localStorage.setItem('skidprot_bans', JSON.stringify(arr)); }

// actions
el('btnBlock').addEventListener('click', async ()=>{
  const ip = el('ipInput').value.trim(); if(!ip){alert('enter ip');return;}
  // try remote
  try {
    const r = await fetch('/api/block',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({ip})});
    if (r.ok) { pushLocalLog('Blocked (remote): '+ip); await refreshStatus(); return; }
  } catch(e){}
  // fallback local
  const bans = JSON.parse(localStorage.getItem('skidprot_bans')||'[]');
  if(!bans.includes(ip)) bans.push(ip);
  saveLocalBanlist(bans); pushLocalLog('Blocked (local): '+ip);
  await refreshStatus();
});
el('btnUnblock').addEventListener('click', async ()=>{
  const ip = el('ipUn').value.trim(); if(!ip){alert('enter ip');return;}
  try {
    const r = await fetch('/api/unblock',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({ip})});
    if (r.ok) { pushLocalLog('Unblocked (remote): '+ip); await refreshStatus(); return; }
  } catch(e){}
  const bans = JSON.parse(localStorage.getItem('skidprot_bans')||'[]').filter(x=>x!==ip);
  saveLocalBanlist(bans); pushLocalLog('Unblocked (local): '+ip);
  await refreshStatus();
});
el('btnRefresh').addEventListener('click', refreshStatus);
el('call-stats').addEventListener('click', async ()=> {
  try { const r = await (await fetch('/api/stats')).json(); alert(JSON.stringify(r)); } catch(e){ alert('api missing') }
});
el('call-banlist').addEventListener('click', async ()=> {
  try { const r = await (await fetch('/api/banlist')).json(); alert(JSON.stringify(r)); } catch(e){ alert('api missing') }
});
el('call-block').addEventListener('click', async ()=> {
  try { await fetch('/api/block',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({ip:'1.2.3.4'})}); alert('ok'); } catch(e){ alert('api missing') }
});
el('clear-logs').addEventListener('click', ()=>{ localStorage.removeItem('skidprot_logs'); renderLogs([]); pushLocalLog('Cleared logs') });
el('simulate-req').addEventListener('click', async ()=>{
  const ip = '192.0.2.' + Math.floor(Math.random()*255);
  calls++; el('stat-calls').textContent = calls;
  // check remote protection
  try {
    const r = await fetch('/api/check',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({ip})});
    if (r.ok) {
      const j = await r.json();
      if (j.blocked) { blocked++; el('stat-blocked').textContent=blocked; pushLocalLog('Remote blocked '+ip); }
      else pushLocalLog('Remote allowed '+ip);
    } else pushLocalLog('Check failed (no api)');
  } catch(e){ pushLocalLog('Check error: '+e.message) }
});
el('simulate-attack').addEventListener('click', async ()=>{
  pushLocalLog('Starting small simulated attack: 30 requests');
  for (let i=0;i<30;i++){ el('simulate-req').click(); await new Promise(r=>setTimeout(r,60)); }
});
el('modeBtn').addEventListener('click', ()=> {
  // toggle: if remote available, switch to local-only or vice versa (client-only)
  if (el('modeBtn').textContent.includes('Local')) el('modeBtn').textContent='Remote mode';
  else el('modeBtn').textContent='Local mode';
});

el('autorefresh').addEventListener('change',(e)=> {
  if (e.target.checked) window._auto = setInterval(refreshStatus,3500);
  else clearInterval(window._auto);
});

// initial load:
(async ()=> {
  // try initial api connect
  await refreshStatus();
  pushLocalLog('SkidProt UI initialized');
})();
</script>
</body>
</html>
